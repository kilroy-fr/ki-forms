{% extends "base.html" %}

{% block title %}{{ form.form_id }} - Felder prüfen{% endblock %}

{% block content %}
<h2>{{ form.form_id }} &mdash; Felder prüfen und ergänzen</h2>

<form action="/form/{{ form.form_id }}/generate/{{ session_id }}" method="post">
    <div class="accordion" id="formSections">
        {% for section_num, section_fields in sections.items() %}
        {% set section_filled = section_fields | selectattr("status", "equalto", "filled") | list | length %}
        {% set section_total = section_fields | length %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button {% if section_filled == section_total %}collapsed{% endif %}"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#section{{ section_num }}">
                    {{ section_titles.get(section_num, "Abschnitt " ~ section_num) }}
                    <span class="badge bg-success section-badge ms-2" title="Ausgefuellt">
                        {{ section_filled }}
                    </span>
                    {% if section_total - section_filled > 0 %}
                    <span class="badge bg-warning text-dark section-badge ms-1" title="Offen">
                        {{ section_total - section_filled }}
                    </span>
                    {% endif %}
                </button>
            </h2>
            <div id="section{{ section_num }}"
                 class="accordion-collapse collapse {% if section_filled < section_total %}show{% endif %}">
                <div class="accordion-body">
                    {% if section_num == 0 %}
                        {# Kopfdaten: Gemischtes Layout #}
                        <style>
                            /* Dreispaltiges Grid für erste Felder: 50%-25%-25% */
                            .kopfdaten-grid-top {
                                display: grid;
                                grid-template-columns: 2fr 1fr 1fr;
                                gap: 1rem 2rem;
                                margin-bottom: 1.5rem;
                            }
                            .kopfdaten-grid-top .field-item {
                                display: flex;
                                flex-direction: column;
                                margin-bottom: 0.5rem;
                            }
                            .kopfdaten-grid-top .field-label {
                                font-weight: 600;
                                margin-bottom: 0.25rem;
                            }
                            .kopfdaten-grid-top .field-input {
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                            }
                            .kopfdaten-grid-top .form-control {
                                flex: 1;
                            }

                            /* Label links, Wert rechts Layout */
                            .kopfdaten-two-column {
                                margin-bottom: 1.5rem;
                            }
                            .kopfdaten-two-column .field-row {
                                display: grid;
                                grid-template-columns: 250px 1fr;
                                gap: 1rem;
                                align-items: center;
                                margin-bottom: 0.75rem;
                                padding: 0.5rem;
                                border-radius: 0.25rem;
                            }
                            .kopfdaten-two-column .field-label {
                                font-weight: 600;
                                text-align: right;
                                padding-right: 1rem;
                            }
                            .kopfdaten-two-column .field-input {
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                            }
                            .kopfdaten-two-column .form-control {
                                flex: 1;
                            }

                            /* Zweispaltiges Grid für Radioboxen */
                            .kopfdaten-radio-grid {
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 0.5rem 2rem;
                                margin-bottom: 1rem;
                            }
                            .kopfdaten-radio-grid .field-item {
                                margin-bottom: 0.25rem;
                            }

                            /* Bedingtes Feld */
                            .kopfdaten-conditional {
                                margin-left: 2rem;
                                margin-top: 0.5rem;
                                padding: 0.75rem;
                                background-color: #23272a;
                                border-radius: 0.25rem;
                                display: none;
                            }
                            .kopfdaten-conditional.show {
                                display: block;
                            }
                        </style>

                        {# Verstecktes Feld für DRV_Kopf_PAF_Reha_MSAT_MSNR #}
                        {% set hidden_field = section_fields | selectattr("field_name", "equalto", "DRV_Kopf_PAF_Reha_MSAT_MSNR") | first %}
                        {% if hidden_field %}
                        <input type="hidden" name="{{ hidden_field.field_name }}" value="{{ hidden_field.value or '' }}">
                        {% endif %}

                        {# Gruppe 1: Zweispaltig - Versicherungsnummer, Kennzeichen, MSAT/MSNR #}
                        <div class="kopfdaten-grid-top">
                            {% for field in section_fields %}
                                {% if field.field_name in ["PAF_VSNR_trim", "PAF_AIGR", "MSAT_MSNR"] %}
                                <div class="field-item {% if field.status.value == 'unfilled' %}field-unfilled{% elif field.status.value == 'filled' %}field-filled{% endif %}">
                                    <label class="field-label form-label mb-0" for="{{ field.field_name }}">
                                        {{ field.label_de }}
                                    </label>
                                    <div class="field-input">
                                        <input type="text" class="form-control"
                                               name="{{ field.field_name }}"
                                               id="{{ field.field_name }}"
                                               value="{{ field.value or '' }}">
                                        {% if field.ai_confidence %}
                                        <span class="badge confidence-{{ field.ai_confidence }}"
                                              title="KI-Konfidenz: {{ field.ai_confidence }}">
                                            {% if field.ai_confidence == "high" %}
                                            <i class="bi bi-check-circle-fill"></i>
                                            {% elif field.ai_confidence == "medium" %}
                                            <i class="bi bi-exclamation-circle-fill"></i>
                                            {% else %}
                                            <i class="bi bi-question-circle-fill"></i>
                                            {% endif %}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        {# Gruppe 2: Label links, Wert rechts - Versicherte/r und Patient/in #}
                        <div class="kopfdaten-two-column">
                            {% for field in section_fields %}
                                {% if field.field_name in ["VERS_NAME", "VERS_GEBDAT", "PAT_NAME", "PAT_Geburtsdatum", "PAT_STRASSE_HNR"] %}
                                <div class="field-row {% if field.status.value == 'unfilled' %}field-unfilled{% elif field.status.value == 'filled' %}field-filled{% endif %}">
                                    <div class="field-label">
                                        <label class="form-label mb-0" for="{{ field.field_name }}">
                                            {{ field.label_de }}
                                        </label>
                                    </div>
                                    <div class="field-input">
                                        <input type="text" class="form-control {% if field.field_name in ['VERS_GEBDAT', 'PAT_Geburtsdatum'] %}date-field{% endif %}"
                                               name="{{ field.field_name }}"
                                               id="{{ field.field_name }}"
                                               value="{{ field.value or '' }}"
                                               {% if field.field_name in ['VERS_GEBDAT', 'PAT_Geburtsdatum'] %}placeholder="TT.MM.JJJJ"{% endif %}>
                                        {% if field.ai_confidence %}
                                        <span class="badge confidence-{{ field.ai_confidence }}"
                                              title="KI-Konfidenz: {{ field.ai_confidence }}">
                                            {% if field.ai_confidence == "high" %}
                                            <i class="bi bi-check-circle-fill"></i>
                                            {% elif field.ai_confidence == "medium" %}
                                            <i class="bi bi-exclamation-circle-fill"></i>
                                            {% else %}
                                            <i class="bi bi-question-circle-fill"></i>
                                            {% endif %}
                                        </span>
                                        {% endif %}
                                        {% if field.field_name in ['VERS_GEBDAT', 'PAT_Geburtsdatum'] %}
                                        <span class="date-error" id="{{ field.field_name }}_error">Bitte Format TT.MM.JJJJ verwenden</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}

                            {# PLZ und Wohnort nebeneinander #}
                            {% set plz_field = section_fields | selectattr("field_name", "equalto", "PAT_PLZ") | first %}
                            {% set wohnort_field = section_fields | selectattr("field_name", "equalto", "PAT_WOHNORT") | first %}
                            {% if plz_field and wohnort_field %}
                            <div class="field-row {% if plz_field.status.value == 'unfilled' or wohnort_field.status.value == 'unfilled' %}field-unfilled{% elif plz_field.status.value == 'filled' and wohnort_field.status.value == 'filled' %}field-filled{% endif %}">
                                <div class="field-label">
                                    <label class="form-label mb-0">PLZ, Wohnort (Patient/in)</label>
                                </div>
                                <div class="field-input" style="display: flex !important; gap: 1rem; align-items: flex-start;">
                                    <input type="text" class="form-control"
                                           style="width: 80px; flex-shrink: 0; min-width: 80px; max-width: 80px;"
                                           name="PAT_PLZ"
                                           id="PAT_PLZ"
                                           placeholder="PLZ"
                                           maxlength="5"
                                           value="{{ plz_field.value or '' }}">
                                    <input type="text" class="form-control"
                                           style="flex: 1; min-width: 0;"
                                           name="PAT_WOHNORT"
                                           id="PAT_WOHNORT"
                                           placeholder="Wohnort"
                                           value="{{ wohnort_field.value or '' }}">
                                    {% if wohnort_field.ai_confidence %}
                                    <span class="badge confidence-{{ wohnort_field.ai_confidence }}"
                                          style="flex-shrink: 0;"
                                          title="KI-Konfidenz: {{ wohnort_field.ai_confidence }}">
                                        {% if wohnort_field.ai_confidence == "high" %}
                                        <i class="bi bi-check-circle-fill"></i>
                                        {% elif wohnort_field.ai_confidence == "medium" %}
                                        <i class="bi bi-exclamation-circle-fill"></i>
                                        {% else %}
                                        <i class="bi bi-question-circle-fill"></i>
                                        {% endif %}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        {# Gruppe 3: Radioboxen zweispaltig #}
                        <div class="kopfdaten-radio-grid">
                            {% for field in section_fields %}
                                {% if field.field_type.value == "radio" and field.radio_group == "AW_1" %}
                                <div class="field-item">
                                    <div class="form-check">
                                        <input class="form-check-input conditional-trigger" type="radio"
                                               name="{{ field.radio_group }}"
                                               id="{{ field.field_name }}"
                                               value="{{ field.field_name }}"
                                               data-trigger="{{ field.field_name }}"
                                               {% if field.value == field.field_name or field.value == 'ja' or field.value == field.pdf_state %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ field.field_name }}">
                                            {{ field.label_de }}
                                        </label>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        {# Gruppe 4: Bedingtes Feld "Sonstige Leistungen (Details)" #}
                        {% set sonstiges = section_fields | selectattr("field_name", "equalto", "SONSTIGES") | first %}
                        {% if sonstiges %}
                        <div class="conditional-field kopfdaten-conditional {% if section_fields | selectattr('field_name', 'equalto', 'AW_1_sonstige') | first | attr('value') == 'AW_1_sonstige' %}show{% endif %}"
                             data-depends-on="AW_1_sonstige">
                            <label class="form-label" for="SONSTIGES">{{ sonstiges.label_de }}</label>
                            <input type="text" class="form-control"
                                   name="SONSTIGES"
                                   id="SONSTIGES"
                                   value="{{ sonstiges.value or '' }}">
                        </div>
                        {% endif %}

                        {# Gruppe 5: Radio-Button AW_3 - Der Antrag erfolgte auf meine Anregung #}
                        <div class="kopfdaten-radio-grid mt-3">
                            {% for field in section_fields %}
                                {% if field.field_type.value == "radio" and field.radio_group == "AW_3" %}
                                <div class="field-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio"
                                               name="{{ field.radio_group }}"
                                               id="{{ field.field_name }}"
                                               value="{{ field.field_name }}"
                                               {% if field.value == field.field_name or field.value == 'ja' or field.value == field.pdf_state %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ field.field_name }}">
                                            {{ field.label_de }}
                                        </label>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% elif section_num == 1 %}
                        {# Behandlung: Zweispaltiges Layout (Label links, Eingabefeld rechts) #}
                        <div class="two-column-form">
                            <style>
                                .two-column-form .field-row {
                                    display: grid;
                                    grid-template-columns: 250px 1fr;
                                    gap: 1rem;
                                    align-items: center;
                                    margin-bottom: 1rem;
                                    padding: 0.5rem;
                                    border-radius: 0.25rem;
                                }
                                .two-column-form .field-label {
                                    font-weight: 600;
                                    text-align: right;
                                    padding-right: 1rem;
                                }
                                .two-column-form .field-input {
                                    display: flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                }
                                .two-column-form .form-control {
                                    flex: 1;
                                }
                                .two-column-form .radio-group-grid {
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 0.5rem;
                                }
                            </style>
                            {% set processed_radio_groups = [] %}
                            {% for field in section_fields %}
                                {% if field.field_type.value == "text" %}
                                <div class="field-row {% if field.status.value == 'unfilled' %}field-unfilled{% elif field.status.value == 'filled' %}field-filled{% endif %}">
                                    <div class="field-label">
                                        <label class="form-label mb-0" for="{{ field.field_name }}">
                                            {{ field.label_de }}
                                        </label>
                                    </div>
                                    <div class="field-input">
                                        <input type="text" class="form-control {% if field.field_name in ['VERS_BEHANDLUNG', 'VERS_KONTAKT_AM'] %}date-field{% endif %}"
                                               name="{{ field.field_name }}"
                                               id="{{ field.field_name }}"
                                               value="{{ field.value or '' }}"
                                               {% if field.field_name in ['VERS_BEHANDLUNG', 'VERS_KONTAKT_AM'] %}placeholder="TT.MM.JJJJ"{% endif %}>
                                        {% if field.ai_confidence %}
                                        <span class="badge confidence-{{ field.ai_confidence }}"
                                              title="KI-Konfidenz: {{ field.ai_confidence }}">
                                            {% if field.ai_confidence == "high" %}
                                            <i class="bi bi-check-circle-fill"></i>
                                            {% elif field.ai_confidence == "medium" %}
                                            <i class="bi bi-exclamation-circle-fill"></i>
                                            {% else %}
                                            <i class="bi bi-question-circle-fill"></i>
                                            {% endif %}
                                        </span>
                                        {% endif %}
                                        {% if field.field_name in ['VERS_BEHANDLUNG', 'VERS_KONTAKT_AM'] %}
                                        <span class="date-error" id="{{ field.field_name }}_error">Bitte Format TT.MM.JJJJ verwenden</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% elif field.field_type.value == "checkbox" %}
                                <div class="field-row">
                                    <div class="field-label"></div>
                                    <div class="field-input">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="{{ field.field_name }}"
                                                   id="{{ field.field_name }}"
                                                   value="ja"
                                                   {% if field.value == 'ja' %}checked{% endif %}>
                                            <label class="form-check-label" for="{{ field.field_name }}">
                                                {{ field.label_de }}
                                            </label>
                                            {% if field.ai_confidence %}
                                            <span class="badge confidence-{{ field.ai_confidence }} ms-1">
                                                {% if field.ai_confidence == "high" %}
                                                <i class="bi bi-check-circle-fill"></i>
                                                {% elif field.ai_confidence == "medium" %}
                                                <i class="bi bi-exclamation-circle-fill"></i>
                                                {% else %}
                                                <i class="bi bi-question-circle-fill"></i>
                                                {% endif %}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% elif field.field_type.value == "radio" %}
                                    {# Prüfe ob diese Radio-Gruppe bereits verarbeitet wurde #}
                                    {% if field.radio_group not in processed_radio_groups %}
                                        {% set _ = processed_radio_groups.append(field.radio_group) %}
                                        {# Sammle alle Felder dieser Radio-Gruppe #}
                                        {% set group_fields = section_fields | selectattr("radio_group", "equalto", field.radio_group) | list %}
                                        {% set group_title = field.radio_group_title if field.radio_group_title else "" %}

                                        <div class="field-row">
                                            <div class="field-label">
                                                {% if group_title %}
                                                <span class="form-label mb-0">{{ group_title }}</span>
                                                {% endif %}
                                            </div>
                                            <div class="field-input">
                                                <div class="radio-group-grid">
                                                    {% for radio_field in group_fields %}
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio"
                                                               name="{{ radio_field.radio_group }}"
                                                               id="{{ radio_field.field_name }}"
                                                               value="{{ radio_field.field_name }}"
                                                               {% if radio_field.value == radio_field.field_name or radio_field.value == 'ja' or radio_field.value == radio_field.pdf_state %}checked{% endif %}>
                                                        <label class="form-check-label" for="{{ radio_field.field_name }}">
                                                            {{ radio_field.label_de }}
                                                        </label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% elif section_num == 2 %}
                        {# Diagnosen-Sektion: Zweispaltige Tabelle ohne Linien #}
                        <div class="diagnoses-table">
                            <style>
                                .diagnoses-table table { border: none; }
                                .diagnoses-table td { border: none; padding: 0.5rem; vertical-align: top; }
                                .diagnoses-table td:first-child { width: 75%; }
                                .diagnoses-table td:nth-child(2) { width: 15%; }
                                .diagnoses-table td:last-child { width: 10%; text-align: center; }
                                /* Diagnose-Textfelder größer machen */
                                .diagnoses-table td:first-child .form-control {
                                    padding: 0.75rem 1rem;
                                    min-height: 48px;
                                    width: 100%;
                                    min-width: 600px;
                                }
                                /* Erste 4 Diagnosen farblich hervorheben */
                                .diagnoses-table tr.primary-diagnosis {
                                    background-color: #2c3e50;
                                    border-radius: 0.25rem;
                                }
                                .diagnoses-table tr.secondary-diagnosis {
                                    opacity: 0.85;
                                }
                                .diagnoses-sort-buttons {
                                    display: flex;
                                    flex-direction: column;
                                    gap: 0.25rem;
                                    align-items: center;
                                    padding-top: 0.5rem;
                                }
                                .diagnoses-sort-buttons button {
                                    width: 32px;
                                    height: 32px;
                                    padding: 0;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    background-color: #495057;
                                    border: 1px solid #6c757d;
                                    color: #fff;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    transition: background-color 0.2s;
                                }
                                .diagnoses-sort-buttons button:hover:not(:disabled) {
                                    background-color: #6c757d;
                                }
                                .diagnoses-sort-buttons button:disabled {
                                    opacity: 0.3;
                                    cursor: not-allowed;
                                }
                                .diagnoses-sort-buttons button i {
                                    font-size: 1.2rem;
                                }
                                .diagnoses-sort-buttons .btn-diagnose-clear {
                                    background-color: #dc3545;
                                    border-color: #dc3545;
                                }
                                .diagnoses-sort-buttons .btn-diagnose-clear:hover {
                                    background-color: #c82333;
                                    border-color: #bd2130;
                                }
                            </style>
                            <table class="w-100">
                                {% for i in range(1, 11) %}
                                <tr class="{% if i <= 4 %}primary-diagnosis{% else %}secondary-diagnosis{% endif %}">
                                    <td>
                                        {% set diag_field = section_fields | selectattr("field_name", "equalto", "VERS_DIAGNOSE_" ~ i) | first %}
                                        {% if diag_field %}
                                        <div class="mb-3 {% if diag_field.status.value == 'unfilled' %}field-unfilled{% elif diag_field.status.value == 'filled' %}field-filled{% endif %}">
                                            <label class="form-label fw-bold" for="{{ diag_field.field_name }}">
                                                {{ diag_field.label_de }}
                                            </label>
                                            {% if diag_field.ai_confidence %}
                                            <span class="badge confidence-{{ diag_field.ai_confidence }}"
                                                  title="KI-Konfidenz: {{ diag_field.ai_confidence }}">
                                                {% if diag_field.ai_confidence == "high" %}
                                                <i class="bi bi-check-circle-fill"></i> sicher
                                                {% elif diag_field.ai_confidence == "medium" %}
                                                <i class="bi bi-exclamation-circle-fill"></i> mittel
                                                {% else %}
                                                <i class="bi bi-question-circle-fill"></i> unsicher
                                                {% endif %}
                                            </span>
                                            {% endif %}
                                            <input type="text" class="form-control"
                                                   name="{{ diag_field.field_name }}"
                                                   id="{{ diag_field.field_name }}"
                                                   value="{{ diag_field.value or '' }}">
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set icd_field = section_fields | selectattr("field_name", "equalto", "VERS_DIAGNOSESCH_" ~ i) | first %}
                                        {% if icd_field %}
                                        <div class="mb-3 {% if icd_field.status.value == 'unfilled' %}field-unfilled{% elif icd_field.status.value == 'filled' %}field-filled{% endif %}">
                                            <label class="form-label fw-bold" for="{{ icd_field.field_name }}">
                                                {{ icd_field.label_de }}
                                            </label>
                                            {% if icd_field.ai_confidence %}
                                            <span class="badge confidence-{{ icd_field.ai_confidence }}"
                                                  title="KI-Konfidenz: {{ icd_field.ai_confidence }}">
                                                {% if icd_field.ai_confidence == "high" %}
                                                <i class="bi bi-check-circle-fill"></i> sicher
                                                {% elif icd_field.ai_confidence == "medium" %}
                                                <i class="bi bi-exclamation-circle-fill"></i> mittel
                                                {% else %}
                                                <i class="bi bi-question-circle-fill"></i> unsicher
                                                {% endif %}
                                            </span>
                                            {% endif %}
                                            <input type="text" class="form-control"
                                                   name="{{ icd_field.field_name }}"
                                                   id="{{ icd_field.field_name }}"
                                                   value="{{ icd_field.value or '' }}">
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="diagnoses-sort-buttons">
                                            <button type="button" class="btn-diagnose-up" data-index="{{ i }}" {% if i == 1 %}disabled{% endif %} title="Nach oben">
                                                <i class="bi bi-chevron-up"></i>
                                            </button>
                                            <button type="button" class="btn-diagnose-clear" data-index="{{ i }}" title="Diagnose löschen">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                            <button type="button" class="btn-diagnose-down" data-index="{{ i }}" {% if i == 10 %}disabled{% endif %} title="Nach unten">
                                                <i class="bi bi-chevron-down"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                    {% elif section_num == 11 %}
                        {# Sektion 11: Arbeitsunfähigkeit / Prognose mit bedingten Feldern #}
                        <div class="sektion-11">
                            <style>
                                .sektion-11 .question-group {
                                    margin-bottom: 2rem;
                                    padding: 1rem;
                                    background-color: #2c2f33;
                                    border-radius: 0.5rem;
                                }
                                .sektion-11 .question-title {
                                    font-weight: 600;
                                    margin-bottom: 1rem;
                                    color: #f8f9fa;
                                }
                                .sektion-11 .conditional-field {
                                    margin-left: 2rem;
                                    margin-top: 0.5rem;
                                    padding: 0.75rem;
                                    background-color: #23272a;
                                    border-radius: 0.25rem;
                                    display: none;
                                }
                                .sektion-11 .conditional-field.show {
                                    display: block;
                                }
                                /* Zweispaltiges Layout für bedingte Felder */
                                .sektion-11 .conditional-field .field-row {
                                    display: grid;
                                    grid-template-columns: 250px 1fr;
                                    gap: 1rem;
                                    align-items: center;
                                    margin-bottom: 0.75rem;
                                }
                                .sektion-11 .conditional-field .field-label {
                                    font-weight: 600;
                                    text-align: right;
                                    padding-right: 1rem;
                                }
                                .sektion-11 .conditional-field .field-input {
                                    display: flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                }
                                .sektion-11 .conditional-field .form-control {
                                    flex: 1;
                                }
                            </style>

                            {# Frage 1: Arbeitsunfähigkeit #}
                            <div class="question-group">
                                <div class="question-title">Die Patientin / der Patient ist derzeit durch mich arbeitsunfähig geschrieben.</div>
                                {% set au_fields = section_fields | selectattr("radio_group", "equalto", "AW_20") | list %}
                                {% for field in au_fields %}
                                <div class="form-check mb-2 p-2 ps-4 rounded">
                                    <input class="form-check-input conditional-trigger" type="radio"
                                           name="{{ field.radio_group }}"
                                           id="{{ field.field_name }}"
                                           value="{{ field.field_name }}"
                                           data-trigger="{{ field.field_name }}"
                                           {% if field.value == field.field_name %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ field.field_name }}">
                                        {{ field.label_de }}
                                    </label>
                                </div>
                                {% endfor %}
                                {# Bedingte Felder für "ja" #}
                                {% set au_seit = section_fields | selectattr("field_name", "equalto", "VERS_BESSERUNG_DATUM_1") | first %}
                                {% set au_grund = section_fields | selectattr("field_name", "equalto", "VERS_AU_GRUND") | first %}
                                <div class="conditional-field" data-depends-on="AW_20_ja">
                                    <div class="field-row">
                                        <div class="field-label">
                                            <label class="form-label mb-0" for="VERS_BESSERUNG_DATUM_1">{{ au_seit.label_de }}</label>
                                        </div>
                                        <div class="field-input">
                                            <input type="text" class="form-control date-field" name="VERS_BESSERUNG_DATUM_1" id="VERS_BESSERUNG_DATUM_1" value="{{ au_seit.value or '' }}" placeholder="TT.MM.JJJJ">
                                            <span class="date-error" id="VERS_BESSERUNG_DATUM_1_error">Bitte Format TT.MM.JJJJ verwenden</span>
                                        </div>
                                    </div>
                                    <div class="field-row">
                                        <div class="field-label">
                                            <label class="form-label mb-0" for="VERS_AU_GRUND">{{ au_grund.label_de }}</label>
                                        </div>
                                        <div class="field-input">
                                            <input type="text" class="form-control" name="VERS_AU_GRUND" id="VERS_AU_GRUND" value="{{ au_grund.value or '' }}">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {# Frage 2: Befundänderung #}
                            <div class="question-group">
                                <div class="question-title">Befundänderung in den letzten 12 Monaten</div>
                                {% set befund_fields = section_fields | selectattr("radio_group", "equalto", "AW_21") | list %}
                                {% for field in befund_fields %}
                                <div class="form-check mb-2 p-2 ps-4 rounded">
                                    <input class="form-check-input conditional-trigger" type="radio"
                                           name="{{ field.radio_group }}"
                                           id="{{ field.field_name }}"
                                           value="{{ field.field_name }}"
                                           data-trigger="{{ field.field_name }}"
                                           {% if field.value == field.field_name %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ field.field_name }}">
                                        {{ field.label_de }}
                                    </label>
                                </div>
                                {% endfor %}
                                {# Bedingte Felder für "ja" #}
                                <div class="conditional-field" data-depends-on="AW_21_ja">
                                    {% set befund_art_fields = section_fields | selectattr("radio_group", "equalto", "AW_22") | list %}
                                    {% for field in befund_art_fields %}
                                    <div class="form-check mb-2 p-2 ps-4 rounded">
                                        <input class="form-check-input conditional-trigger" type="radio"
                                               name="{{ field.radio_group }}"
                                               id="{{ field.field_name }}"
                                               value="{{ field.field_name }}"
                                               data-trigger="{{ field.field_name }}"
                                               {% if field.value == field.field_name %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ field.field_name }}">
                                            {{ field.label_de }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                    {# Datumfeld für Besserung #}
                                    {% set besserung_datum = section_fields | selectattr("field_name", "equalto", "VERS_BESSERUNG_DATUM_2") | first %}
                                    <div class="conditional-field ms-3" data-depends-on="AW_22_besserung">
                                        <div class="field-row">
                                            <div class="field-label">
                                                <label class="form-label mb-0" for="VERS_BESSERUNG_DATUM_2">{{ besserung_datum.label_de }}</label>
                                            </div>
                                            <div class="field-input">
                                                <input type="text" class="form-control date-field" name="VERS_BESSERUNG_DATUM_2" id="VERS_BESSERUNG_DATUM_2" value="{{ besserung_datum.value or '' }}" placeholder="TT.MM.JJJJ">
                                                <span class="date-error" id="VERS_BESSERUNG_DATUM_2_error">Bitte Format TT.MM.JJJJ verwenden</span>
                                            </div>
                                        </div>
                                    </div>
                                    {# Datumfeld für Verschlechterung #}
                                    {% set verschlechterung_datum = section_fields | selectattr("field_name", "equalto", "VERS_VERSCHLECHTERUNG_DATUM") | first %}
                                    <div class="conditional-field ms-3" data-depends-on="AW_22_verschlechterung">
                                        <div class="field-row">
                                            <div class="field-label">
                                                <label class="form-label mb-0" for="VERS_VERSCHLECHTERUNG_DATUM">{{ verschlechterung_datum.label_de }}</label>
                                            </div>
                                            <div class="field-input">
                                                <input type="text" class="form-control date-field" name="VERS_VERSCHLECHTERUNG_DATUM" id="VERS_VERSCHLECHTERUNG_DATUM" value="{{ verschlechterung_datum.value or '' }}" placeholder="TT.MM.JJJJ">
                                                <span class="date-error" id="VERS_VERSCHLECHTERUNG_DATUM_error">Bitte Format TT.MM.JJJJ verwenden</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {# Frage 3: Deutsche Sprache #}
                            <div class="question-group">
                                <div class="question-title">Verständigung ist in deutscher Sprache möglich</div>
                                {% set sprache_fields = section_fields | selectattr("radio_group", "equalto", "AW_23") | list %}
                                {% for field in sprache_fields %}
                                <div class="form-check mb-2 p-2 ps-4 rounded">
                                    <input class="form-check-input conditional-trigger" type="radio"
                                           name="{{ field.radio_group }}"
                                           id="{{ field.field_name }}"
                                           value="{{ field.field_name }}"
                                           data-trigger="{{ field.field_name }}"
                                           {% if field.value == field.field_name %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ field.field_name }}">
                                        {{ field.label_de }}
                                    </label>
                                </div>
                                {% endfor %}
                                {# Bedingtes Feld für "nein" #}
                                {% set sprache = section_fields | selectattr("field_name", "equalto", "VERS_SPRACHE_23_1") | first %}
                                <div class="conditional-field" data-depends-on="AW_23_nein">
                                    <div class="field-row">
                                        <div class="field-label">
                                            <label class="form-label mb-0" for="VERS_SPRACHE_23_1">{{ sprache.label_de }}</label>
                                        </div>
                                        <div class="field-input">
                                            <input type="text" class="form-control" name="VERS_SPRACHE_23_1" id="VERS_SPRACHE_23_1" value="{{ sprache.value or '' }}">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {# Frage 4: Reisefähigkeit #}
                            <div class="question-group">
                                <div class="question-title">Reisefähigkeit für öffentliche Verkehrsmittel besteht.</div>
                                {% set reise_fields = section_fields | selectattr("radio_group", "equalto", "AW_24") | list %}
                                {% for field in reise_fields %}
                                <div class="form-check mb-2 p-2 ps-4 rounded">
                                    <input class="form-check-input conditional-trigger" type="radio"
                                           name="{{ field.radio_group }}"
                                           id="{{ field.field_name }}"
                                           value="{{ field.field_name }}"
                                           data-trigger="{{ field.field_name }}"
                                           {% if field.value == field.field_name %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ field.field_name }}">
                                        {{ field.label_de }}
                                    </label>
                                </div>
                                {% endfor %}
                                {# Bedingtes Feld für "ja" #}
                                {% set begleitung = section_fields | selectattr("field_name", "equalto", "AW_24_1") | first %}
                                <div class="conditional-field" data-depends-on="AW_24_ja">
                                    <div class="field-row">
                                        <div class="field-label">
                                            <label class="form-label mb-0">Begleitung</label>
                                        </div>
                                        <div class="field-input">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="AW_24_1" id="AW_24_1" value="ja" {% if begleitung.value == 'ja' %}checked{% endif %}>
                                                <label class="form-check-label" for="AW_24_1">{{ begleitung.label_de }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {# Frage 5: Besserung der Leistungsfähigkeit #}
                            <div class="question-group">
                                <div class="question-title">Besserung der Leistungsfähigkeit ist möglich.</div>
                                {% set besserung_fields = section_fields | selectattr("radio_group", "equalto", "AW_25") | list %}
                                {% for field in besserung_fields %}
                                <div class="form-check mb-2 p-2 ps-4 rounded">
                                    <input class="form-check-input" type="radio"
                                           name="{{ field.radio_group }}"
                                           id="{{ field.field_name }}"
                                           value="{{ field.field_name }}"
                                           {% if field.value == field.field_name %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ field.field_name }}">
                                        {{ field.label_de }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>

                            {# Frage 6: Belastbarkeit für Rehabilitation #}
                            <div class="question-group">
                                <div class="question-title">Belastbarkeit für eine Rehabilitation besteht.</div>
                                {% set belastbarkeit_fields = section_fields | selectattr("radio_group", "equalto", "AW_26") | list %}
                                {% for field in belastbarkeit_fields %}
                                <div class="form-check mb-2 p-2 ps-4 rounded">
                                    <input class="form-check-input" type="radio"
                                           name="{{ field.radio_group }}"
                                           id="{{ field.field_name }}"
                                           value="{{ field.field_name }}"
                                           {% if field.value == field.field_name %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ field.field_name }}">
                                        {{ field.label_de }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                    {% elif section_num == 10 %}
                        {# Sektion 10: Risikofaktoren #}
                        <div class="risikofaktoren-container">
                            <style>
                                .risikofaktoren-grid {
                                    display: grid;
                                    grid-template-columns: repeat(3, 1fr);
                                    gap: 1rem;
                                }
                                .risikofaktoren-grid .form-check,
                                .risikofaktoren-radio {
                                    padding: 0.75rem;
                                    background-color: #2c2f33;
                                    border-radius: 0.25rem;
                                }
                                .risikofaktoren-radio {
                                    margin-bottom: 1rem;
                                }
                            </style>

                            {# Checkboxen: AW_13, AW_15-AW_19 #}
                            <div class="risikofaktoren-grid">
                                {% for field in section_fields %}
                                {% if field.field_type.value == "checkbox" %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           name="{{ field.field_name }}"
                                           id="{{ field.field_name }}"
                                           value="ja"
                                           {% if field.value == 'ja' %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ field.field_name }}">
                                        {{ field.label_de }}
                                    </label>
                                    {% if field.ai_confidence %}
                                    <span class="badge confidence-{{ field.ai_confidence }} ms-1">
                                        {% if field.ai_confidence == "high" %}
                                        <i class="bi bi-check-circle-fill"></i>
                                        {% elif field.ai_confidence == "medium" %}
                                        <i class="bi bi-exclamation-circle-fill"></i>
                                        {% else %}
                                        <i class="bi bi-question-circle-fill"></i>
                                        {% endif %}
                                    </span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>

                            {# Radiogruppe: AW_14 (Übergewicht/Untergewicht) #}
                            {% set aw14_fields = section_fields | selectattr("radio_group", "equalto", "AW_14") | list %}
                            {% if aw14_fields %}
                            <div class="risikofaktoren-radio mt-3">
                                <div class="fw-bold mb-2">Gewicht:</div>
                                <div class="d-flex gap-3">
                                    {% set aw14_selected = (
                                        aw14_fields
                                        | rejectattr("value", "equalto", none)
                                        | rejectattr("value", "equalto", "")
                                        | rejectattr("value", "equalto", "nein")
                                        | list
                                        | length
                                    ) > 0 %}
                                    {% for field in aw14_fields %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio"
                                               name="{{ field.radio_group }}"
                                               id="{{ field.field_name }}"
                                               value="{{ field.field_name }}"
                                               {% if field.value == field.field_name or field.value == 'ja' or field.value == field.pdf_state %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ field.field_name }}">
                                            {{ field.label_de }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio"
                                               name="AW_14"
                                               id="AW_14_none"
                                               value=""
                                               {% if not aw14_selected %}checked{% endif %}>
                                        <label class="form-check-label" for="AW_14_none">
                                            keine Auswahl
                                        </label>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                    {% elif section_num == 5 %}
                        {# Aktivitäten und Teilhabe: Radio-Button-Matrix #}
                        <div class="aktivitaeten-table">
                            <style>
                                .aktivitaeten-table table {
                                    width: 100%;
                                    border-collapse: collapse;
                                }
                                .aktivitaeten-table th, .aktivitaeten-table td {
                                    border: 1px solid #495057;
                                    padding: 0.75rem;
                                    text-align: center;
                                    vertical-align: middle;
                                }
                                .aktivitaeten-table th {
                                    background-color: #495057;
                                    color: #f8f9fa;
                                    font-weight: 600;
                                    font-size: 0.9rem;
                                }
                                .aktivitaeten-table td:first-child {
                                    text-align: left;
                                    font-weight: 500;
                                    background-color: #6c757d;
                                    color: #f8f9fa;
                                    width: 25%;
                                }
                                .aktivitaeten-table td.radio-cell {
                                    width: 15%;
                                    background-color: #343a40;
                                }
                                .aktivitaeten-table .form-check-input[type="radio"] {
                                    width: 2em;
                                    height: 2em;
                                    cursor: pointer;
                                }
                            </style>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Bereich</th>
                                        <th>keine Beeinträchtigungen</th>
                                        <th>Einschränkungen</th>
                                        <th>Personelle Hilfe nötig</th>
                                        <th>nicht durchführbar</th>
                                        <th>Keine Angabe möglich</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set aktivitaeten = [
                                        ('AW_4', 'Lernen und Wissensanwendung'),
                                        ('AW_5', 'Allgemeine Aufgaben und Anforderungen'),
                                        ('AW_6', 'Kommunikation'),
                                        ('AW_7', 'Mobilität'),
                                        ('AW_8', 'Arbeit und Beschäftigung'),
                                        ('AW_9', 'Erziehung / Bildung'),
                                        ('AW_10', 'Interpersonelle Aktivitäten'),
                                        ('AW_11', 'Häusl. Leben / Haushaltsführung'),
                                        ('AW_12', 'Selbstversorgung')
                                    ] %}
                                    {% for radio_group, label in aktivitaeten %}
                                    <tr>
                                        <td>{{ label }}</td>
                                        {% set group_fields = section_fields | selectattr("radio_group", "equalto", radio_group) | list %}
                                        {% for field in group_fields %}
                                        <td class="radio-cell">
                                            <input class="form-check-input" type="radio"
                                                   name="{{ field.radio_group }}"
                                                   id="{{ field.field_name }}"
                                                   value="{{ field.field_name }}"
                                                   {% if field.value == field.field_name or field.value == 'ja' or field.value == field.pdf_state %}checked{% endif %}>
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% elif section_num == 7 %}
                        {# Sektion 7: Befunde - Untersuchungsbefunde (80%) und Körpergröße/Gewicht (20%) #}
                        <div class="befunde-section">
                            <style>
                                .befunde-section .befunde-layout {
                                    display: grid;
                                    grid-template-columns: 80% 20%;
                                    gap: 1.5rem;
                                    margin-bottom: 1rem;
                                }
                                .befunde-section .body-measurements {
                                    display: flex;
                                    flex-direction: column;
                                    gap: 1rem;
                                }
                                .befunde-section .measurement-item {
                                    display: flex;
                                    flex-direction: column;
                                }
                                .befunde-section .measurement-item label {
                                    font-weight: 600;
                                    margin-bottom: 0.5rem;
                                }
                                .befunde-section .measurement-input-wrapper {
                                    display: flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                }
                                .befunde-section .measurement-item input {
                                    width: 100%;
                                }
                            </style>

                            {# Layout: Untersuchungsbefunde links (80%), Körpergröße/Gewicht rechts (20%) #}
                            {% set untersuchung_field = section_fields | selectattr("field_name", "equalto", "UNTERSUCHUNGSBEFUNDE") | first %}
                            {% set groesse_field = section_fields | selectattr("field_name", "equalto", "VERS_KOERPERLAENGE") | first %}
                            {% set gewicht_field = section_fields | selectattr("field_name", "equalto", "VERS_GEWICHT") | first %}

                            {% if untersuchung_field and groesse_field and gewicht_field %}
                            <div class="befunde-layout">
                                {# Linke Spalte: Untersuchungsbefunde (80%) #}
                                <div class="p-2 rounded {% if untersuchung_field.status.value == 'unfilled' %}field-unfilled{% elif untersuchung_field.status.value == 'filled' %}field-filled{% endif %}">
                                    <label class="form-label fw-bold" for="UNTERSUCHUNGSBEFUNDE">
                                        {{ untersuchung_field.label_de }}
                                    </label>
                                    {% if untersuchung_field.ai_confidence %}
                                    <span class="badge confidence-{{ untersuchung_field.ai_confidence }}"
                                          title="KI-Konfidenz: {{ untersuchung_field.ai_confidence }}">
                                        {% if untersuchung_field.ai_confidence == "high" %}
                                        <i class="bi bi-check-circle-fill"></i> sicher
                                        {% elif untersuchung_field.ai_confidence == "medium" %}
                                        <i class="bi bi-exclamation-circle-fill"></i> mittel
                                        {% else %}
                                        <i class="bi bi-question-circle-fill"></i> unsicher
                                        {% endif %}
                                    </span>
                                    {% endif %}
                                    <textarea class="form-control w-100 large-textarea"
                                              name="UNTERSUCHUNGSBEFUNDE"
                                              id="UNTERSUCHUNGSBEFUNDE"
                                              rows="12">{{ untersuchung_field.value or '' }}</textarea>
                                </div>

                                {# Rechte Spalte: Körpergröße und Gewicht untereinander (20%) #}
                                <div class="body-measurements">
                                    <div class="measurement-item p-2 rounded {% if groesse_field.status.value == 'unfilled' %}field-unfilled{% elif groesse_field.status.value == 'filled' %}field-filled{% endif %}">
                                        <label class="form-label mb-0" for="VERS_KOERPERLAENGE">
                                            Körpergröße (cm)
                                        </label>
                                        <div class="measurement-input-wrapper">
                                            <input type="text" class="form-control"
                                                   name="VERS_KOERPERLAENGE"
                                                   id="VERS_KOERPERLAENGE"
                                                   value="{{ groesse_field.value or '' }}">
                                            {% if groesse_field.ai_confidence %}
                                            <span class="badge confidence-{{ groesse_field.ai_confidence }}"
                                                  title="KI-Konfidenz: {{ groesse_field.ai_confidence }}">
                                                {% if groesse_field.ai_confidence == "high" %}
                                                <i class="bi bi-check-circle-fill"></i>
                                                {% elif groesse_field.ai_confidence == "medium" %}
                                                <i class="bi bi-exclamation-circle-fill"></i>
                                                {% else %}
                                                <i class="bi bi-question-circle-fill"></i>
                                                {% endif %}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="measurement-item p-2 rounded {% if gewicht_field.status.value == 'unfilled' %}field-unfilled{% elif gewicht_field.status.value == 'filled' %}field-filled{% endif %}">
                                        <label class="form-label mb-0" for="VERS_GEWICHT">
                                            Gewicht (kg)
                                        </label>
                                        <div class="measurement-input-wrapper">
                                            <input type="text" class="form-control"
                                                   name="VERS_GEWICHT"
                                                   id="VERS_GEWICHT"
                                                   value="{{ gewicht_field.value or '' }}">
                                            {% if gewicht_field.ai_confidence %}
                                            <span class="badge confidence-{{ gewicht_field.ai_confidence }}"
                                                  title="KI-Konfidenz: {{ gewicht_field.ai_confidence }}">
                                                {% if gewicht_field.ai_confidence == "high" %}
                                                <i class="bi bi-check-circle-fill"></i>
                                                {% elif gewicht_field.ai_confidence == "medium" %}
                                                <i class="bi bi-exclamation-circle-fill"></i>
                                                {% else %}
                                                <i class="bi bi-question-circle-fill"></i>
                                                {% endif %}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {# Andere Felder der Sektion 7 #}
                            {% for field in section_fields %}
                                {% if field.field_name not in ["UNTERSUCHUNGSBEFUNDE", "VERS_KOERPERLAENGE", "VERS_GEWICHT"] %}
                                    {% if field.field_type.value == "text" %}
                                    <div class="mb-3 p-2 rounded {% if field.status.value == 'unfilled' %}field-unfilled{% elif field.status.value == 'filled' %}field-filled{% endif %}">
                                        <label class="form-label fw-bold" for="{{ field.field_name }}">
                                            {{ field.label_de }}
                                        </label>
                                        {% if field.ai_confidence %}
                                        <span class="badge confidence-{{ field.ai_confidence }}"
                                              title="KI-Konfidenz: {{ field.ai_confidence }}">
                                            {% if field.ai_confidence == "high" %}
                                            <i class="bi bi-check-circle-fill"></i> sicher
                                            {% elif field.ai_confidence == "medium" %}
                                            <i class="bi bi-exclamation-circle-fill"></i> mittel
                                            {% else %}
                                            <i class="bi bi-question-circle-fill"></i> unsicher
                                            {% endif %}
                                        </span>
                                        {% endif %}

                                        {% if field.field_name in long_text_fields %}
                                        <textarea class="form-control w-100 large-textarea"
                                                  name="{{ field.field_name }}"
                                                  id="{{ field.field_name }}"
                                                  rows="12">{{ field.value or '' }}</textarea>
                                        {% else %}
                                        <input type="text" class="form-control"
                                               name="{{ field.field_name }}"
                                               id="{{ field.field_name }}"
                                               value="{{ field.value or '' }}">
                                        {% endif %}
                                    </div>
                                    {% elif field.field_type.value == "checkbox" %}
                                    <div class="form-check mb-2 p-2 ps-4 rounded">
                                        <input class="form-check-input" type="checkbox"
                                               name="{{ field.field_name }}"
                                               id="{{ field.field_name }}"
                                               value="ja"
                                               {% if field.value == 'ja' %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ field.field_name }}">
                                            {{ field.label_de }}
                                        </label>
                                        {% if field.ai_confidence %}
                                        <span class="badge confidence-{{ field.ai_confidence }} ms-1">
                                            {% if field.ai_confidence == "high" %}
                                            <i class="bi bi-check-circle-fill"></i>
                                            {% elif field.ai_confidence == "medium" %}
                                            <i class="bi bi-exclamation-circle-fill"></i>
                                            {% else %}
                                            <i class="bi bi-question-circle-fill"></i>
                                            {% endif %}
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                    {% for field in section_fields %}
                        {% if field.field_type.value == "text" %}
                        <div class="mb-3 p-2 rounded {% if field.field_name in ['ANAMNESE', 'FUNKTIONSEINSCHRAENKUNGEN', 'THERAPIE', 'UNTERSUCHUNGSBEFUNDE', 'MED_TECHN_BEFUNDE', 'LEBENSUMSTAENDE', 'BEMERKUNGEN'] %}w-100{% endif %} {% if field.status.value == 'unfilled' %}field-unfilled{% elif field.status.value == 'filled' %}field-filled{% endif %}">
                            <label class="form-label fw-bold" for="{{ field.field_name }}">
                                {{ field.label_de }}
                            </label>
                            {% if field.ai_confidence %}
                            <span class="badge confidence-{{ field.ai_confidence }}"
                                  title="KI-Konfidenz: {{ field.ai_confidence }}">
                                {% if field.ai_confidence == "high" %}
                                <i class="bi bi-check-circle-fill"></i> sicher
                                {% elif field.ai_confidence == "medium" %}
                                <i class="bi bi-exclamation-circle-fill"></i> mittel
                                {% else %}
                                <i class="bi bi-question-circle-fill"></i> unsicher
                                {% endif %}
                            </span>
                            {% endif %}

                            {% if field.field_name in long_text_fields %}
                            <textarea class="form-control w-100 large-textarea"
                                      name="{{ field.field_name }}"
                                      id="{{ field.field_name }}"
                                      rows="12">{{ field.value or '' }}</textarea>
                            {% else %}
                            <input type="text" class="form-control"
                                   name="{{ field.field_name }}"
                                   id="{{ field.field_name }}"
                                   value="{{ field.value or '' }}">
                            {% endif %}
                        </div>

                        {% elif field.field_type.value == "checkbox" %}
                        <div class="form-check mb-2 p-2 ps-4 rounded {% if field.status.value == 'unfilled' and field.value != 'ja' %}{% endif %}">
                            <input class="form-check-input" type="checkbox"
                                   name="{{ field.field_name }}"
                                   id="{{ field.field_name }}"
                                   value="ja"
                                   {% if field.value == 'ja' %}checked{% endif %}>
                            <label class="form-check-label" for="{{ field.field_name }}">
                                {{ field.label_de }}
                            </label>
                            {% if field.ai_confidence %}
                            <span class="badge confidence-{{ field.ai_confidence }} ms-1">
                                {% if field.ai_confidence == "high" %}
                                <i class="bi bi-check-circle-fill"></i>
                                {% elif field.ai_confidence == "medium" %}
                                <i class="bi bi-exclamation-circle-fill"></i>
                                {% else %}
                                <i class="bi bi-question-circle-fill"></i>
                                {% endif %}
                            </span>
                            {% endif %}
                        </div>

                        {% elif field.field_type.value == "radio" %}
                        <div class="form-check mb-2 p-2 ps-4 rounded">
                            <input class="form-check-input" type="radio"
                                   name="{{ field.radio_group }}"
                                   id="{{ field.field_name }}"
                                   value="{{ field.field_name }}"
                                   {% if field.value == field.field_name or field.value == 'ja' or field.value == field.pdf_state %}checked{% endif %}>
                            <label class="form-check-label" for="{{ field.field_name }}">
                                {{ field.label_de }}
                            </label>
                        </div>
                        {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="mt-5 d-flex gap-2">
        <button type="submit" class="btn btn-success btn-execute" id="generatePdfBtn">
            <i class="bi bi-file-earmark-pdf"></i> PDF erstellen
        </button>
        <a href="/form/{{ form.form_id }}/upload" class="btn btn-outline-secondary btn-execute">
            <i class="bi bi-arrow-counterclockwise"></i> Neu starten
        </a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script src="/static/js/review.js"></script>
<script>
// Datumsvalidierung (TT.MM.JJJJ)
function validateDateField(input) {
    const value = input.value.trim();
    const errorSpan = document.getElementById(input.id + '_error');

    // Leere Felder sind erlaubt
    if (value === '') {
        input.classList.remove('invalid');
        if (errorSpan) errorSpan.classList.remove('show');
        return true;
    }

    // Prüfe Format TT.MM.JJJJ
    const datePattern = /^(\d{2})\.(\d{2})\.(\d{4})$/;
    const match = value.match(datePattern);

    if (!match) {
        input.classList.add('invalid');
        if (errorSpan) errorSpan.classList.add('show');
        return false;
    }

    const day = parseInt(match[1], 10);
    const month = parseInt(match[2], 10);
    const year = parseInt(match[3], 10);

    // Plausibilitätsprüfung
    if (month < 1 || month > 12) {
        input.classList.add('invalid');
        if (errorSpan) errorSpan.classList.add('show');
        return false;
    }

    if (day < 1 || day > 31) {
        input.classList.add('invalid');
        if (errorSpan) errorSpan.classList.add('show');
        return false;
    }

    // Vereinfachte Tagesprüfung für Monate
    const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    if (day > daysInMonth[month - 1]) {
        input.classList.add('invalid');
        if (errorSpan) errorSpan.classList.add('show');
        return false;
    }

    // Jahr sollte plausibel sein (1900-2100)
    if (year < 1900 || year > 2100) {
        input.classList.add('invalid');
        if (errorSpan) errorSpan.classList.add('show');
        return false;
    }

    // Validierung erfolgreich
    input.classList.remove('invalid');
    if (errorSpan) errorSpan.classList.remove('show');
    return true;
}

// Validierung für alle Datumsfelder einrichten
document.addEventListener('DOMContentLoaded', function() {
    const dateFields = document.querySelectorAll('.date-field');

    dateFields.forEach(function(field) {
        // Validierung beim Verlassen des Felds
        field.addEventListener('blur', function() {
            validateDateField(this);
        });

        // Validierung während der Eingabe (nach Pause)
        let timeout;
        field.addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                validateDateField(this);
            }, 500);
        });
    });

    // Entferne field-unfilled Markierung, wenn ein Feld ausgefüllt wird
    const allInputs = document.querySelectorAll('.form-control, .form-check-input');
    allInputs.forEach(function(input) {
        input.addEventListener('input', function() {
            // Finde das übergeordnete Element mit field-unfilled Klasse
            let parent = this.closest('.field-unfilled');
            if (parent && this.value && this.value.trim() !== '') {
                parent.classList.remove('field-unfilled');
                parent.classList.add('field-filled');
            }
        });

        // Für Checkboxen und Radio-Buttons
        input.addEventListener('change', function() {
            let parent = this.closest('.field-unfilled');
            if (parent && (this.checked || (this.value && this.value.trim() !== ''))) {
                parent.classList.remove('field-unfilled');
                parent.classList.add('field-filled');
            }
        });
    });
});

// DEBUG: Zeige Formular-Daten in der Console (OHNE Submit zu blockieren)
document.querySelector('form').addEventListener('submit', function(e) {
    // Validiere alle Datumsfelder vor dem Submit
    const dateFields = document.querySelectorAll('.date-field');
    let hasErrors = false;

    dateFields.forEach(function(field) {
        if (!validateDateField(field)) {
            hasErrors = true;
        }
    });

    if (hasErrors) {
        e.preventDefault();
        alert('Bitte korrigieren Sie die markierten Datumsfelder (Format: TT.MM.JJJJ)');
        return false;
    }

    const formData = new FormData(this);

    console.log('='.repeat(80));
    console.log('FORMULAR-DATEN:');
    console.log('='.repeat(80));

    const radios = new Map();
    const checkboxes = [];
    const texts = [];

    for (let [key, value] of formData.entries()) {
        if (key.startsWith('AW_') && /^AW_\d+$/.test(key)) {
            // Radio-Button
            radios.set(key, value);
        } else if (key.startsWith('AW_') || key === 'AW_24_1') {
            checkboxes.push(key);
        } else {
            texts.push(key);
        }
    }

    console.log('Text-Felder:', texts.length);
    console.log('Checkboxen:', checkboxes.length);
    console.log('Radio-Buttons:', radios.size);

    // Aktivitäten zählen
    const aktivitaeten = Array.from(radios.keys()).filter(k => {
        const n = parseInt(k.split('_')[1]);
        return n >= 4 && n <= 12;
    });

    console.log('Aktivitaeten (AW_4-AW_12):', aktivitaeten.length);
    aktivitaeten.forEach(k => console.log('  ' + k + ' = ' + radios.get(k)));

    console.log('='.repeat(80));

    // Formular wird normal weitergeleitet (wenn keine Fehler)
});

// Diagnosen-Sortierung
document.addEventListener('DOMContentLoaded', function() {
    // Event-Listener für Up-Buttons
    document.querySelectorAll('.btn-diagnose-up').forEach(button => {
        button.addEventListener('click', function() {
            const currentIndex = parseInt(this.dataset.index);
            const previousIndex = currentIndex - 1;

            if (previousIndex >= 1) {
                swapDiagnoses(currentIndex, previousIndex);
            }
        });
    });

    // Event-Listener für Down-Buttons
    document.querySelectorAll('.btn-diagnose-down').forEach(button => {
        button.addEventListener('click', function() {
            const currentIndex = parseInt(this.dataset.index);
            const nextIndex = currentIndex + 1;

            if (nextIndex <= 10) {
                swapDiagnoses(currentIndex, nextIndex);
            }
        });
    });

    // Event-Listener für Clear-Buttons
    document.querySelectorAll('.btn-diagnose-clear').forEach(button => {
        button.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            clearDiagnose(index);
        });
    });
});

function swapDiagnoses(index1, index2) {
    // Diagnose-Textfelder
    const diag1 = document.getElementById('VERS_DIAGNOSE_' + index1);
    const diag2 = document.getElementById('VERS_DIAGNOSE_' + index2);

    // ICD-Code-Felder
    const icd1 = document.getElementById('VERS_DIAGNOSESCH_' + index1);
    const icd2 = document.getElementById('VERS_DIAGNOSESCH_' + index2);

    if (diag1 && diag2 && icd1 && icd2) {
        // Werte tauschen
        const tempDiag = diag1.value;
        diag1.value = diag2.value;
        diag2.value = tempDiag;

        const tempIcd = icd1.value;
        icd1.value = icd2.value;
        icd2.value = tempIcd;

        // CSS-Klassen tauschen (field-filled/field-unfilled)
        const diag1Parent = diag1.closest('.mb-3');
        const diag2Parent = diag2.closest('.mb-3');
        const icd1Parent = icd1.closest('.mb-3');
        const icd2Parent = icd2.closest('.mb-3');

        // Diagnose-Felder
        const diag1HasFilled = diag1Parent.classList.contains('field-filled');
        const diag1HasUnfilled = diag1Parent.classList.contains('field-unfilled');
        const diag2HasFilled = diag2Parent.classList.contains('field-filled');
        const diag2HasUnfilled = diag2Parent.classList.contains('field-unfilled');

        diag1Parent.classList.remove('field-filled', 'field-unfilled');
        diag2Parent.classList.remove('field-filled', 'field-unfilled');

        if (diag2HasFilled) diag1Parent.classList.add('field-filled');
        if (diag2HasUnfilled) diag1Parent.classList.add('field-unfilled');
        if (diag1HasFilled) diag2Parent.classList.add('field-filled');
        if (diag1HasUnfilled) diag2Parent.classList.add('field-unfilled');

        // ICD-Code-Felder
        const icd1HasFilled = icd1Parent.classList.contains('field-filled');
        const icd1HasUnfilled = icd1Parent.classList.contains('field-unfilled');
        const icd2HasFilled = icd2Parent.classList.contains('field-filled');
        const icd2HasUnfilled = icd2Parent.classList.contains('field-unfilled');

        icd1Parent.classList.remove('field-filled', 'field-unfilled');
        icd2Parent.classList.remove('field-filled', 'field-unfilled');

        if (icd2HasFilled) icd1Parent.classList.add('field-filled');
        if (icd2HasUnfilled) icd1Parent.classList.add('field-unfilled');
        if (icd1HasFilled) icd2Parent.classList.add('field-filled');
        if (icd1HasUnfilled) icd2Parent.classList.add('field-unfilled');

        // Kurze visuelle Feedback-Animation
        [diag1Parent, diag2Parent, icd1Parent, icd2Parent].forEach(el => {
            el.style.transition = 'background-color 0.3s';
            el.style.backgroundColor = '#3d4449';
            setTimeout(() => {
                el.style.backgroundColor = '';
            }, 300);
        });
    }
}

function clearDiagnose(index) {
    // Diagnose-Textfeld
    const diagField = document.getElementById('VERS_DIAGNOSE_' + index);
    // ICD-Code-Feld
    const icdField = document.getElementById('VERS_DIAGNOSESCH_' + index);

    if (diagField && icdField) {
        // Felder leeren
        diagField.value = '';
        icdField.value = '';

        // CSS-Klassen aktualisieren
        const diagParent = diagField.closest('.mb-3');
        const icdParent = icdField.closest('.mb-3');

        if (diagParent) {
            diagParent.classList.remove('field-filled');
            diagParent.classList.add('field-unfilled');
        }

        if (icdParent) {
            icdParent.classList.remove('field-filled');
            icdParent.classList.add('field-unfilled');
        }

        // Kurze visuelle Feedback-Animation
        [diagParent, icdParent].forEach(el => {
            if (el) {
                el.style.transition = 'background-color 0.3s';
                el.style.backgroundColor = '#4a1f1f';
                setTimeout(() => {
                    el.style.backgroundColor = '';
                }, 300);
            }
        });
    }
}
</script>
{% endblock %}
