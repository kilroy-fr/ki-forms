{% extends "base.html" %}

{% block title %}KI-Forms{% endblock %}

{% block content %}

<!-- Zwei-Spalten-Layout: Formularauswahl und Absender-Daten -->
<div class="two-column-layout mb-4">
    <!-- Linke Spalte: Formularauswahl (67%) -->
    <div>
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="form-selection-wrapper">
                    <div class="form-selection-left">
                        <h2 class="card-title mb-3">Formular auswählen</h2>
                        <select class="form-select form-select-lg" id="formSelect">
                            <option value="">-- Formular wählen --</option>
                            {% for form_id, form_def in forms.items() %}
                            <option value="{{ form_id }}"
                                    data-title="{{ form_def.form_title }}"
                                    data-fields="{{ form_def.fields | length }}"
                                    {% if completed_form == form_id %}selected{% endif %}>
                                {{ form_id }} &mdash; {{ form_def.form_title }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="thumbnail-container d-none" id="thumbnailContainer">
                        <img id="formThumbnail" class="form-thumbnail" alt="Formularvorschau">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rechte Spalte: Absender-Daten (33%) -->
    <div>
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="card-title mb-0">Absender-Daten</h2>
                    <button class="btn btn-sm btn-primary" id="editSenderBtn">
                        <i class="bi bi-pencil"></i> Bearbeiten
                    </button>
                </div>
                <div id="senderDataDisplay" class="sender-data-display">
                    <p class="text-muted text-center py-4">
                        <i class="bi bi-person-badge fs-1 d-block mb-2"></i>
                        Noch keine Absender-Daten hinterlegt
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Container 2: Upload & Aktionen -->
<div class="card shadow-sm mb-4" id="uploadSection">
    <div class="card-body">
        <h2 class="card-title mb-3">Dokumente hochladen</h2>
        <p class="text-muted">
            Laden Sie die PDF-Dokumente hoch, aus denen das Formular ausgefüllt werden soll
            (z.B. Arztbriefe, Befundberichte, Entlassungsbriefe).
        </p>

        <form id="uploadForm" method="post" enctype="multipart/form-data">
            <div class="upload-zone mb-3" id="dropZone">
                <i class="bi bi-cloud-arrow-up"></i>
                <p class="mt-2 mb-1 fw-bold">PDF-Dateien hierher ziehen</p>
                <p class="text-muted mb-0">oder klicken zum Auswählen</p>
                <input type="file" name="files" id="fileInput" multiple accept=".pdf"
                       class="d-none">
            </div>
            <div class="alert alert-info d-flex align-items-center gap-2" role="alert">
                <i class="bi bi-info-circle"></i>
                <span>Unterstützte Formate: PDF (auch gescannte Dokumente mit OCR-Erkennung).
                Maximal 10 Dateien, je max. 50 MB.</span>
            </div>

            <div id="fileList" class="mb-3"></div>



            <div class="d-flex flex-wrap gap-2">
                <button type="submit" class="btn btn-primary btn-execute" id="submitBtn" disabled>
                    <i class="bi bi-cpu"></i> Ausführen
                </button>

                {% if download_url %}
                <a href="{{ download_url }}" class="btn btn-success btn-execute" id="downloadBtn" download>
                    <i class="bi bi-download"></i> Download
                </a>
                <a href="{{ download_url }}" class="btn btn-outline-secondary btn-execute" id="printBtn" target="_blank>
                    <i class="bi bi-printer"></i> Drucken
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Modal für Absender-Daten -->
<div class="sender-modal-overlay d-none" id="senderModal">
    <div class="sender-modal">
        <div class="sender-modal-header">
            <h3 class="mb-0">Absender-Daten bearbeiten</h3>
            <button class="btn-close btn-close-white" id="closeSenderModal" aria-label="Schließen"></button>
        </div>
        <div class="sender-modal-body">
            <form id="senderDataForm">
                <!-- Anrede -->
                <label for="anrede" class="form-label">Anrede</label>
                <select class="form-select" id="anrede" name="anrede">
                    <option value="">-- Bitte wählen --</option>
                    <option value="Herr">Herr</option>
                    <option value="Frau">Frau</option>
                </select>

                <!-- Titel -->
                <label for="titel" class="form-label">Titel</label>
                <select class="form-select" id="titel" name="titel">
                    <option value="">-- Kein Titel --</option>
                    <option value="Dr. med.">Dr. med.</option>
                </select>

                <!-- Vorname -->
                <label for="vorname" class="form-label">Vorname</label>
                <input type="text" class="form-control" id="vorname" name="vorname">

                <!-- Name -->
                <label for="name" class="form-label">Name</label>
                <input type="text" class="form-control" id="name" name="name">

                <!-- Fachrichtung -->
                <label for="fachrichtung" class="form-label">Fachrichtung</label>
                <input type="text" class="form-control" id="fachrichtung" name="fachrichtung" placeholder="z.B. Facharzt für Innere Medizin">

                <!-- Praxis -->
                <label for="praxis" class="form-label">Praxis</label>
                <input type="text" class="form-control" id="praxis" name="praxis">

                <!-- Straße -->
                <label for="strasse" class="form-label">Straße</label>
                <input type="text" class="form-control" id="strasse" name="strasse">

                <!-- Hausnummer -->
                <label for="hausnummer" class="form-label">Hausnummer</label>
                <input type="text" class="form-control" id="hausnummer" name="hausnummer">

                <!-- PLZ -->
                <label for="plz" class="form-label">PLZ</label>
                <input type="text" class="form-control" id="plz" name="plz" maxlength="5" pattern="\d{5}">

                <!-- Ort -->
                <label for="ort" class="form-label">Ort</label>
                <input type="text" class="form-control" id="ort" name="ort">

                <!-- Telefon -->
                <label for="telefon" class="form-label">Telefon</label>
                <input type="tel" class="form-control" id="telefon" name="telefon">

                <!-- E-Mail -->
                <label for="email" class="form-label">E-Mail</label>
                <input type="email" class="form-control" id="email" name="email">

                <!-- Bankdaten Überschrift -->
                <h5 class="mt-4 mb-3">Bankdaten</h5>

                <!-- Kontoinhaber -->
                <label for="kontoinhaber" class="form-label">Kontoinhaber</label>
                <input type="text" class="form-control" id="kontoinhaber" name="kontoinhaber">

                <!-- IBAN -->
                <label for="iban" class="form-label">IBAN</label>
                <input type="text" class="form-control" id="iban" name="iban">

                <!-- BIC -->
                <label for="bic" class="form-label">BIC</label>
                <input type="text" class="form-control" id="bic" name="bic">

                <!-- Kreditinstitut -->
                <label for="kreditinstitut" class="form-label">Kreditinstitut</label>
                <input type="text" class="form-control" id="kreditinstitut" name="kreditinstitut">

                <!-- Buttons -->
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button type="button" class="btn btn-outline-secondary" id="cancelSenderBtn">
                        Abbrechen
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/upload.js"></script>
<script src="/static/js/sender-data.js"></script>
{% endblock %}
